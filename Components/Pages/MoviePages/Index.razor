@* @page "/movies"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.QuickGrid
@using BlazorWebAppMovies.Models
@using BlazorWebAppMovies.Data
@implements IAsyncDisposable
@inject IDbContextFactory<BlazorWebAppMovies.Data.BlazorWebAppMoviesContext> DbFactory

<PageTitle>Index</PageTitle>

<h1>Index</h1>

<p>
    <a href="movies/create">Create New</a>
</p>

<QuickGrid Class="table" Items="context.Movie">
    <PropertyColumn Property="movie => movie.Title" />
    <PropertyColumn Property="movie => movie.ReleaseDate" />
    <PropertyColumn Property="movie => movie.Genre" />
    <PropertyColumn Property="movie => movie.Price" />

    <TemplateColumn Context="movie">
        <a href="@($"movies/edit?id={movie.Id}")">Edit</a> |
        <a href="@($"movies/details?id={movie.Id}")">Details</a> |
        <a href="@($"movies/delete?id={movie.Id}")">Delete</a>
    </TemplateColumn>
</QuickGrid>

@code {
    private BlazorWebAppMoviesContext context = default!;

    protected override void OnInitialized()
    {
        context = DbFactory.CreateDbContext();
    }

    public async ValueTask DisposeAsync() => await context.DisposeAsync();
} *@
@page "/movies"
@using BlazorWebAppMovies.Dtos.Movie
@using BlazorWebAppMovies.Services.MovieService
@using BlazorWebAppMovies.UnitOfWork
@using Microsoft.EntityFrameworkCore
@using BlazorWebAppMovies.Models
@using BlazorWebAppMovies.Data
@inject IMovieService movieService
@rendermode InteractiveServer
@* @implements IAsyncDisposable
 *@
@*  @inject IDbContextFactory<BlazorWebAppMoviesContext> DbFactory 
 *@
<PageTitle>قائمة الأفلام</PageTitle>

<h1>Index </h1>

<p>
    <a href="movies/create" class="btn btn-primary">Create New</a>
</p>

@if (movies == null)
{
    <p><em>جاري تحميل البيانات...</em></p>
}
else
{<div class="input-group">
    <input type="text" class="form-control" placeholder="Search by title..."
               @bind="SearchString" @oninput="OnSearchInput" />
    <button type="button" class="btn btn-primary" @onclick="()=>FilterMovies(true)" >Search</button>
</div>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Title</th>
                <th>Release Date</th>
                <th>Genre</th>
                <th>Price</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var movie in movies)
            {
                <tr>
                    <td>@movie.Title</td>
                    <td>@movie.ReleaseDate</td>
                    <td>@(movie.GenreName?? "No Genre")</td>
                    <td>@movie.Price.ToString("C")</td>
                    <td>
                        <a href="@($"movies/edit?id={movie.Id}")">Edit</a> |
                        <a href="@($"movies/details?id={movie.Id}")">Details</a> |
                        <a href="@($"movies/delete?id={movie.Id}")">Delete</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
    <div class="mt-3 text-center" >
        <button class="btn btn-primary"
                disabled="@(CurrentPage <= 1)"
                @onclick="() => ChangePage(CurrentPage - 1)">
            Previous
        </button>

        <span>Page @CurrentPage of @TotalPages</span>

        <button class="btn btn-primary"
                disabled="@(CurrentPage >= TotalPages)"
                @onclick="() => ChangePage(CurrentPage + 1)">
            Next
        </button>
    </div>
}

@code {
    private List<MovieReadDto> movies = default!;
    private string SearchString = string.Empty;
    private int TotalPages = 0;
    private int CurrentPage = 1;
    private int PageSize = 10;

    protected override async Task OnInitializedAsync()
    {
        await FilterMovies();
    }
    private async Task FilterMovies(bool resetPage = false)
    {
        if (resetPage) CurrentPage = 1;
       var result = await movieService.GetFilteredMoviesAsync(CurrentPage, PageSize, SearchString);
        if (result.IsSuccess && result.Data != null)
        {
            movies = result.Data.Items.ToList();

            TotalPages = result.Data.TotalPages;
        }
        else
        {
            movies = new List<MovieReadDto>();
            TotalPages = 0;
        }
    }
    private async Task OnSearchInput(ChangeEventArgs e)
    {
        SearchString = e.Value?.ToString() ?? string.Empty;
        // شيلنا الـ if وخليناه يفلتر مع كل حرف بيتكتب أو بيتمسح
        await FilterMovies(true);
    }
    private async Task ChangePage(int newPage)
    {
        CurrentPage = newPage;
        await FilterMovies(); // بنعيد البحث بس بالصفحة الجديدة
    }
}


@* @code{
    private List<Movie> movies = default!;
    private string SearchString = string.Empty;
    private int TotalPages = 0;
    private int CurrentPage = 1;
    private int PageSize = 10;

    protected override async Task OnInitializedAsync()
    {
        await FilterMovies();
    }
    private async Task FilterMovies(bool resetPage = false)
    {
        if (resetPage) CurrentPage = 1;
        using var context = DbFactory.CreateDbContext();
        var query = context.Movie.AsNoTracking().AsQueryable();
        if (!string.IsNullOrWhiteSpace(SearchString))
        {
            // حول العنوان لنص صغير والبحث لنص صغير وقارن بينهم
            query = query.Where(t => t.Title.ToLower().Contains(SearchString.ToLower()));
        }
        var count = await query.CountAsync();
        TotalPages =(int) Math.Ceiling(count /(double) PageSize);
        movies = await query.OrderBy(t => t.Title).Skip((CurrentPage - 1) * PageSize).Take(PageSize).ToListAsync();
    }
    private async Task OnSearchInput(ChangeEventArgs e)
    {
        SearchString = e.Value?.ToString() ?? string.Empty;
        // شيلنا الـ if وخليناه يفلتر مع كل حرف بيتكتب أو بيتمسح
        await FilterMovies(true);
    }
    private async Task ChangePage(int newPage)
    {
        CurrentPage = newPage;
        await FilterMovies(); // بنعيد البحث بس بالصفحة الجديدة
    }
 } *@
@* @code {
    private BlazorWebAppMoviesContext context = default!;
    private List<Movie> movies = default!;

    protected override async Task OnInitializedAsync()
    {
        // 1. نفتح الاتصال بقاعدة البيانات
        context = DbFactory.CreateDbContext();

        // 2. نسحب البيانات من جدول Movies ونحولها لـ List
        movies = await context.Movie.AsNoTracking().ToListAsync();
    }

    public async ValueTask DisposeAsync() => await context.DisposeAsync();
}
 *@
 @* النقطة	التعريف بره (على مستوى الصفحة)	التعريف جوه (جوه الدالة مع using)
الاستهلاك	بيفضل حاجز مكان في الذاكرة طول ما إنت واقف في الصفحة.	بيشغل الذاكرة ثانية واحدة ويختفي فوراً.
الأمان	خطر جداً في الـ Multi-threading (لو الصفحة بتعمل حاجتين سوا).	أمان 100% لأن كل دالة ليها "عالمها الخاص".
دقة البحث	ممكن يتلخبط بين عمليات البحث المتتالية.	دايماً بيبدأ بحث "نضيف" من الصفر. *@